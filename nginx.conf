# 宝塔主 nginx.conf 的 http{} 块里需加（软件商店→Nginx→配置修改，加在 http{ 下一行）：
# proxy_cache_path /tmp/nginx_pic_cache levels=1:2 keys_zone=pic_cache:10m max_size=500m inactive=7d use_temp_path=off;

server {
    listen 80;
    server_name YOUR_DOMAIN;

    proxy_http_version 1.1;
    proxy_ssl_server_name on;
    proxy_ssl_verify off;
    proxy_set_header Accept-Encoding '';
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    gunzip on;

    proxy_hide_header X-Frame-Options;
    proxy_hide_header Content-Security-Policy;

    proxy_redirect https://www.codefather.cn http://YOUR_DOMAIN;
    proxy_redirect https://api.codefather.cn http://YOUR_DOMAIN/api;
    proxy_cookie_domain .codefather.cn YOUR_DOMAIN;
    proxy_cookie_flags ~. nosecure max-age=2592000;

    gzip on;
    gzip_vary on;
    gzip_types application/javascript application/json text/css text/plain;
    gzip_min_length 1024;

    proxy_buffer_size 128k;
    proxy_buffers 8 128k;
    proxy_busy_buffers_size 256k;

    location /pic/ {
        proxy_pass https://pic.code-nav.cn/;
        proxy_set_header Host pic.code-nav.cn;
        proxy_set_header Accept-Encoding '';
        proxy_set_header Referer "https://www.codefather.cn";
        proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36";
        proxy_set_header Cookie "";
        proxy_cache pic_cache;
        proxy_cache_key "$uri";
        proxy_cache_valid 200 7d;
        proxy_cache_lock on;
        proxy_cache_use_stale error timeout updating;
        proxy_ignore_headers Cache-Control Set-Cookie;
        proxy_hide_header Set-Cookie;
        add_header X-Cache-Status $upstream_cache_status always;
    }

    location /api/ {
        proxy_pass https://api.codefather.cn/api/;
        proxy_set_header Host api.codefather.cn;
        proxy_set_header Accept-Encoding '';
        proxy_set_header Cookie "YOUR_COOKIE_HERE";
        proxy_set_header Referer https://www.codefather.cn;
        proxy_set_header Origin https://www.codefather.cn;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_hide_header Access-Control-Allow-Credentials;
        proxy_hide_header Cache-Control;
        add_header Access-Control-Allow-Origin "http://YOUR_DOMAIN" always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Cache-Control "no-store" always;
        client_max_body_size 100m;
        proxy_request_buffering off;
        sub_filter_once off;
        sub_filter_types *;
        sub_filter_last_modified off;
        sub_filter 'https://pic.code-nav.cn' 'http://YOUR_DOMAIN/pic';
        sub_filter 'https://api.codefather.cn' 'http://YOUR_DOMAIN/api';
        sub_filter 'https://www.codefather.cn' 'http://YOUR_DOMAIN';
    }

    location /_next/static/ {
        proxy_pass https://www.codefather.cn/_next/static/;
        proxy_set_header Host www.codefather.cn;
        proxy_set_header Accept-Encoding '';
        proxy_hide_header Cache-Control;
        add_header Cache-Control "public, max-age=31536000, immutable" always;
    }

    location / {
        proxy_pass https://www.codefather.cn;
        proxy_set_header Host www.codefather.cn;
        proxy_set_header Accept-Encoding '';
        proxy_set_header Cookie "YOUR_COOKIE_HERE";
        proxy_set_header Referer https://www.codefather.cn;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        sub_filter_once off;
        sub_filter_types *;
        sub_filter_last_modified off;
        sub_filter '<head>' '<head><script>(function(){var O="https://api.codefather.cn",L=location.origin;var oF=window.fetch;window.fetch=function(i,n){if(typeof i==="string")i=i.split(O).join(L);else if(i&&i.url){var u=i.url.split(O).join(L);if(u!==i.url)i=new Request(u,i)}return oF.call(this,i,n)};var oX=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(m,u){if(typeof u==="string")u=u.split(O).join(L);return oX.apply(this,[m,u].concat([].slice.call(arguments,2)))};function tryRefresh(n){var h=document.querySelector("head");if(!h)return;var fk=Object.getOwnPropertyNames(h).find(function(k){return k.startsWith("__reactFiber")});if(!fk){if(n>0)setTimeout(function(){tryRefresh(n-1)},100);return}var r=h[fk];while(r.return)r=r.return;var q=[[r,0]],s=new WeakSet();while(q.length){var t=q.shift(),f=t[0],d=t[1];if(!f||d>50||s.has(f))continue;s.add(f);var v=f.memoizedProps&&f.memoizedProps.value;if(v&&typeof v.refresh==="function"){v.refresh();return}if(f.child)q.push([f.child,d+1]);if(f.sibling)q.push([f.sibling,d+1])}if(n>0)setTimeout(function(){tryRefresh(n-1)},100)}setTimeout(function(){tryRefresh(20)},0);})();</script>';
        sub_filter 'https://api.codefather.cn' 'http://YOUR_DOMAIN/api';
        sub_filter 'https://www.codefather.cn' 'http://YOUR_DOMAIN';
        sub_filter 'https://pic.code-nav.cn' 'http://YOUR_DOMAIN/pic';
    }
}
